<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Bus Attendance System</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- AOS CSS -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="text-center mb-5" data-aos="fade-down">
                    <h1 class="display-4 text-primary"><i class="fas fa-bus me-2"></i>College Bus Attendance System</h1>
                    <p class="lead">Efficient attendance tracking for college transportation</p>
                </div>

                <ul class="nav nav-tabs mb-4" id="attendanceTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button" role="tab">
                            <i class="fas fa-user-check me-2"></i>Mark Attendance
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="registration-tab" data-bs-toggle="tab" data-bs-target="#registration" type="button" role="tab">
                            <i class="fas fa-user-plus me-2"></i>Admin Registration
                        </button>
                    </li>
                </ul>

                <div class="tab-content bg-white p-4 rounded-bottom shadow-sm" id="attendanceTabsContent">
                    <!-- Attendance Tab -->
                    <div class="tab-pane fade show active" id="attendance" role="tabpanel">
                        <div class="text-center mb-4" data-aos="fade-up">
                            <h3 class="text-primary"><i class="fas fa-qrcode me-2"></i>Scan Your ID</h3>
                            <p class="text-muted">Position your QR code or barcode in the frame below</p>
                        </div>

                        <div class="card mb-4" data-aos="zoom-in">
                            <div class="card-body p-2">
                                <div class="scanner-container position-relative" id="scannerContainer" style="display: none;">
                                    <div id="qrReader" class="w-100"></div>
                                    <div class="scanner-overlay position-absolute top-0 start-0 w-100 h-100 border border-primary border-3"></div>
                                    <div class="scanner-guide position-absolute top-0 start-50 translate-middle-x w-75 bg-primary bg-opacity-50" style="height: 2px; animation: scan 2s infinite linear;"></div>
                                </div>

                                <div class="text-center mt-3">
                                    <button id="scanToggle" class="btn btn-primary btn-lg">
                                        <i class="fas fa-camera me-2"></i>Start Scanning
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex align-items-center my-4" data-aos="fade-up">
                            <hr class="flex-grow-1">
                            <span class="px-3 text-muted">OR</span>
                            <hr class="flex-grow-1">
                        </div>

                        <div data-aos="fade-up">
                            <h4 class="text-center mb-3"><i class="fas fa-keyboard me-2"></i>Manual Entry</h4>
                            <form id="attendanceForm" action="https://script.google.com/macros/s/AKfycbxJtHBq2nk2LTb_-cBIEXMMUzKIb1TZSbbk2GJVqsdCyCYhsdbtCaMXk7nQF8hWDfOWYA/exec" method="POST" target="_blank">
                                <input type="hidden" name="action" value="attendance">
                                
                                <div class="mb-3">
                                    <label for="regNo" class="form-label">Registration Number</label>
                                    <input type="text" class="form-control form-control-lg" id="regNo" name="regNo" required placeholder="Enter your registration number">
                                </div>
                                
                                <button type="submit" id="markAttendanceBtn" class="btn btn-success btn-lg w-100">
                                    <i class="fas fa-check-circle me-2"></i>Mark Attendance
                                </button>
                            </form>
                        </div>

                        <div id="attendanceResult" class="mt-3 text-center"></div>
                    </div>

                    <!-- Registration Tab -->
                    <div class="tab-pane fade" id="registration" role="tabpanel">
                        <div data-aos="fade-up">
                            <h3 class="text-center text-primary mb-4"><i class="fas fa-user-graduate me-2"></i>Student Registration</h3>
                            
                            <form id="registrationForm" action="https://script.google.com/macros/s/AKfycbxJtHBq2nk2LTb_-cBIEXMMUzKIb1TZSbbk2GJVqsdCyCYhsdbtCaMXk7nQF8hWDfOWYA/exec" method="POST" target="_blank">
                                <input type="hidden" name="action" value="register">
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="adminRegNo" class="form-label">Registration Number</label>
                                        <input type="text" class="form-control" id="adminRegNo" name="regNo" required placeholder="Student's ID">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="name" class="form-label">Full Name</label>
                                        <input type="text" class="form-control" id="name" name="name" required placeholder="Student's full name">
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="dept" class="form-label">Department</label>
                                        <input type="text" class="form-control" id="dept" name="dept" required placeholder="e.g., CSE, ECE, MECH">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="year" class="form-label">Year</label>
                                        <select class="form-select" id="year" name="year" required>
                                            <option value="">Select Year</option>
                                            <option value="1">1st Year</option>
                                            <option value="2">2nd Year</option>
                                            <option value="3">3rd Year</option>
                                            <option value="4">4th Year</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="busStop" class="form-label">Bus Stop</label>
                                    <input type="text" class="form-control" id="busStop" name="busStop" required placeholder="Nearest bus stop name">
                                </div>
                                
                                <button type="submit" class="btn btn-primary btn-lg w-100">
                                    <i class="fas fa-save me-2"></i>Register Student
                                </button>
                            </form>
                            
                            <div id="registrationResult" class="mt-3 text-center"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QR/Barcode Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- AOS JS -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    
    <script>
        // Initialize AOS animation
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true
        });

        // Scanner variables
        let currentScanner = null;
        let scannerActive = false;
        let lastScannedTime = 0;
        const scanDelay = 2000; // 2 seconds between scans

        // Scanner management functions
        function stopScanner() {
            if (currentScanner) {
                currentScanner.stop().then(() => {
                    console.log("Scanner stopped");
                    document.getElementById('scannerContainer').style.display = 'none';
                    document.getElementById('scanToggle').innerHTML = '<i class="fas fa-camera me-2"></i>Start Scanning';
                    scannerActive = false;
                    currentScanner = null;
                }).catch(err => {
                    console.error("Failed to stop scanner", err);
                });
            }
        }
        
        function startScanner() {
            const scannerContainer = document.getElementById('scannerContainer');
            const qrReader = document.getElementById('qrReader');
            
            scannerContainer.style.display = 'block';
            qrReader.innerHTML = '';
            document.getElementById('scanToggle').innerHTML = '<i class="fas fa-stop-circle me-2"></i>Stop Scanning';
            scannerActive = true;
            
            function onScanSuccess(decodedText, decodedResult) {
                const currentTime = new Date().getTime();
                
                // Prevent multiple scans in quick succession
                if (currentTime - lastScannedTime < scanDelay) {
                    return;
                }
                lastScannedTime = currentTime;
                
                console.log(`Scanned: ${decodedText}`, decodedResult);
                
                // Validate the scanned code looks like a registration number
                if (isValidRegistrationNumber(decodedText)) {
                    // Auto-fill the registration number field
                    document.getElementById('regNo').value = decodedText;
                    
                    // Show scanning success feedback
                    const resultDiv = document.getElementById('attendanceResult');
                    resultDiv.innerHTML = `
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Scanned successfully!</strong> Registration number detected.
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    `;
                    
                    // Auto-submit the form after a brief delay
                    setTimeout(() => {
                        document.getElementById('markAttendanceBtn').click();
                    }, 500);
                } else {
                    // Show error message but keep scanning
                    const resultDiv = document.getElementById('attendanceResult');
                    resultDiv.innerHTML = `
                        <div class="alert alert-warning alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Invalid code!</strong> Please scan a valid registration number.
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    `;
                }
            }
            
            function onScanFailure(error) {
                console.warn(`Scan error: ${error}`);
            }
            
            // Scanner configuration with enhanced detection
            const config = {
                fps: 15,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0,
                disableFlip: false,
                focusMode: "continuous", // Auto-focus enabled
                supportedScanTypes: [
                    Html5QrcodeScanType.SCAN_TYPE_CAMERA,
                    Html5QrcodeScanType.SCAN_TYPE_FILE
                ],
                formatsToSupport: [
                    Html5QrcodeSupportedFormats.QR_CODE,
                    Html5QrcodeSupportedFormats.UPC_A,
                    Html5QrcodeSupportedFormats.UPC_E,
                    Html5QrcodeSupportedFormats.UPC_EAN_EXTENSION,
                    Html5QrcodeSupportedFormats.CODE_39,
                    Html5QrcodeSupportedFormats.CODE_128,
                    Html5QrcodeSupportedFormats.EAN_8,
                    Html5QrcodeSupportedFormats.EAN_13,
                    Html5QrcodeSupportedFormats.CODABAR,
                    Html5QrcodeSupportedFormats.ITF,
                    Html5QrcodeSupportedFormats.AZTEC
                ]
            };
            
            currentScanner = new Html5Qrcode("qrReader");
            currentScanner.start(
                { 
                    facingMode: "environment",
                    focusMode: "continuous" // Force continuous focus
                }, 
                config,
                onScanSuccess,
                onScanFailure
            ).catch(err => {
                console.error("Failed to start scanner", err);
                scannerContainer.style.display = 'none';
                document.getElementById('scanToggle').innerHTML = '<i class="fas fa-camera me-2"></i>Start Scanning';
                scannerActive = false;
                currentScanner = null;
                
                // Show error message
                const resultDiv = document.getElementById('attendanceResult');
                resultDiv.innerHTML = `
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <strong>Scanner error!</strong> ${err.message || 'Please ensure camera access is allowed and try again.'}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
            });
        }
        
        function isValidRegistrationNumber(text) {
            // Basic validation - adjust according to your registration number format
            return text && text.trim().length >= 5 && /^[a-zA-Z0-9]+$/.test(text);
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const result = urlParams.get('result');
            const action = urlParams.get('action');
            
            // Handle results from form submission
            if (result && action) {
                const resultDiv = action === 'attendance' 
                    ? document.getElementById('attendanceResult')
                    : document.getElementById('registrationResult');
                
                if (result.includes("âœ…") || result.toLowerCase().includes("success")) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            ${result}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            ${result}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    `;
                }
                
                // Scroll to the result
                resultDiv.scrollIntoView({ behavior: 'smooth' });
            }
            
            // Scanner toggle functionality
            const scanToggle = document.getElementById('scanToggle');
            scanToggle.addEventListener('click', function() {
                if (scannerActive) {
                    stopScanner();
                } else {
                    startScanner();
                }
            });
            
            // Stop scanner when switching tabs
            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(e) {
                    if (e.target.id !== 'attendance-tab' && scannerActive) {
                        stopScanner();
                    }
                });
            });
            
            // Manual form submission handler
            document.getElementById('attendanceForm').addEventListener('submit', function(e) {
                const regNo = document.getElementById('regNo').value.trim();
                if (!isValidRegistrationNumber(regNo)) {
                    e.preventDefault();
                    const resultDiv = document.getElementById('attendanceResult');
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <strong>Invalid registration number!</strong> Please enter a valid ID.
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    `;
                    return false;
                }
                return true;
            });
        });

        // Scanner animation
        document.head.insertAdjacentHTML('beforeend', `
            <style>
                @keyframes scan {
                    0% { top: 10%; opacity: 0.5; }
                    50% { opacity: 1; }
                    100% { top: 90%; opacity: 0.5; }
                }
                .scanner-guide {
                    animation: scan 2s infinite linear;
                }
            </style>
        `);
    </script>
</body>
</html>
